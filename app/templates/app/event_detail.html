{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <!-- Mensajes -->
  {% if messages %}
    <div class="alert-container">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Detalles del evento -->
  <div class="container">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 class="mb-0">{{ event.title }}</h1>
          {% if user_is_organizer %}
            <a href="{% url 'event_edit' event.id %}" class="btn btn-outline-primary">
              <i class="bi bi-pencil me-1"></i>Editar Evento
            </a>
          {% endif %}
        </div>
        
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title text-primary mb-3">Detalles del Evento</h5>
            <p class="card-text lead">{{ event.description }}</p>
            
            <div class="mt-4">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-light rounded-circle p-2 me-3">
                  <i class="bi bi-calendar-event text-primary fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1 text-muted">Fecha y Hora</h6>
                  <p class="mb-0 fs-5">{{ event.scheduled_at|date:"l, j \\d\\e F \\d\\e Y, H:i" }}</p>
                </div>
              </div>
              
              <div class="d-flex align-items-center">
                <div class="bg-light rounded-circle p-2 me-3">
                  <i class="bi bi-person text-primary fs-4"></i>
                </div>
                <div>
                  <h6 class="mb-1 text-muted">Organizador</h6>
                  <p class="mb-0 fs-5">{{ event.organizer }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección de Calificaciones -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="card-title text-primary mb-4">
              <i class="bi bi-star-fill text-warning me-2"></i>
              Calificaciones y Reseñas ({{ ratings.count }})
            </h4>
            
            {% if ratings %}
              <div class="ratings-container">
                {% for rating in ratings %}
                  <div class="rating-item mb-4 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                       
                          <strong class="fs-5">{{ rating.user.username }}</strong>
                          <div class="mb-2">
                            <small class="text-muted">{{ rating.created_at|date:"d M Y, H:i" }}</small>
                          </div>
                          <div>
                        </div>
                        
                        <div class="text-warning mb-2">
                          {% for i in "12345" %}
                            {% if forloop.counter <= rating.rating %}★{% else %}☆{% endif %}
                          {% endfor %}
                        </div>
                        
                        <h5 class="mb-2">{{ rating.title }}</h5>
                        <p class="mb-0">{{ rating.text }}</p>
                      </div>
                      
                      {% if user.is_authenticated and user == rating.user or user == event.organizer %}
                        <div class="dropdown ms-3">
                          <button class="btn btn-sm btn-light rounded-circle" 
                                  type="button" 
                                  data-bs-toggle="dropdown" 
                                  aria-expanded="false"
                                  style="width: 32px; height: 32px;">
                            <i class="bi bi-three-dots"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            {% if user == rating.user %}
                              <li>
                                <a class="dropdown-item" href="{% url 'update_rating' event.id rating.id %}">
                                  <i class="bi bi-pencil me-2"></i>Editar
                                </a>
                              </li>
                            {% endif %}
                            <li>
                              <a class="dropdown-item text-danger" 
                                 href="{% url 'delete_rating' event.id rating.id %}"
                                 onclick="return confirm('¿Eliminar esta calificación?')">
                                <i class="bi bi-trash me-2"></i>Eliminar
                              </a>
                            </li>
                          </ul>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center py-4">
                <i class="bi bi-star text-muted fs-1"></i>
                <p class="text-muted mt-2">Este evento aún no tiene calificaciones.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Formulario de Calificación -->
    {% if user.is_authenticated %}
      {% if not user_rating %}
        <div class="row">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body">
                <h4 class="card-title text-primary mb-4">
                  <i class="bi bi-plus-circle me-2"></i>
                  Agregar tu calificación
                </h4>
                
                <form method="post" action="{% url 'create_rating' event.id %}" id="ratingForm">
                  {% csrf_token %}
                  <input type="hidden" name="rating" id="ratingInput" value="3">
                  
                  <div class="mb-4">
                    <label class="form-label fw-bold">¿Cómo calificarías este evento?</label>
                    <div class="rating-stars">
                      {% for i in "12345" %}
                        <label data-value="{{ forloop.counter }}" class="star-label">
                          <span class="star-icon {% if forloop.counter <= 3 %}active{% endif %}">
                            <i class="bi bi-star-fill fs-2"></i>
                          </span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="id_title" class="form-label fw-bold">Título de tu reseña*</label>
                    <input type="text" name="title" id="id_title" class="form-control form-control-lg" 
                           placeholder="Ej: 'Experiencia increíble'" required maxlength="100">
                  </div>
                  
                  <div class="mb-3">
                    <label for="id_text" class="form-label fw-bold">Comentario (opcional)</label>
                    <textarea name="text" id="id_text" class="form-control" rows="4"
                              placeholder="Comparte tu experiencia..."></textarea>
                  </div>

                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                      <i class="bi bi-send me-2"></i>Publicar calificación
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% else %}
      <div class="alert alert-info text-center">
        <i class="bi bi-info-circle me-2"></i>
        <a href="{% url 'login' %}?next={% url 'event_detail' event.id %}" class="alert-link">
          Inicia sesión
        </a> para dejar tu calificación.
      </div>
    {% endif %}
  </div>
</div>

<!--Seccion de estilos-->
<style>
  .rating-stars { 
    display: flex; 
    gap: 10px;
    margin: 10px 0 20px;
  }
  .star-label { 
    cursor: pointer; 
    transition: transform 0.2s;
  }
  .star-label:hover {
    transform: scale(1.1);
  }
  .star-icon { 
    color: #e0e0e0; 
    transition: color 0.2s;
  }
  .star-icon.active,
  .star-label:hover .star-icon { 
    color: #f39c12; 
  }
  .rating-item {
    transition: all 0.3s ease;
    padding: 15px;
    border-radius: 8px;
  }
  .rating-item:hover {
    background-color: #f8f9fa;
  }
  .alert-container { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    z-index: 1000; 
    width: 300px; 
  }
  .dropdown-toggle::after {
    display: none;
  }
</style>

<script>
  // Manejo de estrellas
  document.querySelectorAll('.star-label').forEach(star => {
    star.addEventListener('click', function() {
      const value = this.getAttribute('data-value');
      document.getElementById('ratingInput').value = value;
      
      document.querySelectorAll('.star-icon').forEach((icon, index) => {
        icon.classList.toggle('active', index < value);
      });
    });
  });

  // Validación del formulario
  document.getElementById('ratingForm')?.addEventListener('submit', function(e) {
    const ratingValue = parseInt(document.getElementById('ratingInput').value);
    const titleValue = document.getElementById('id_title').value.trim();
    
    if (isNaN(ratingValue) || ratingValue < 1 || ratingValue > 5) {
      e.preventDefault();
      alert('Por favor selecciona una calificación entre 1 y 5 estrellas');
      return false;
    }
    
    if (!titleValue) {
      e.preventDefault();
      alert('El título es obligatorio');
      return false;
    }
  });
  
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(alert => {
        alert.style.display = 'none';
      });
    }, 5000);
  });
</script>
{% endblock %}
